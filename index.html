<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bilan Sant√© Simplifi√© ‚Äî Competition</title>
<style>
:root{
  --blue:#0b63a7;
  --bg:#617591 ;
  --text:#090909;
  --muted:#000000;
  --card:#ffffff;
  --danger:#ff4d4f;
  font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;
}

/* Page layout */
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  padding:18px;
  -webkit-font-smoothing:antialiased;
}
.container{
  max-width:900px;
  margin:0 auto;
  display:grid;
  gap:20px;
}

/* Logos */
.top-logos{
  display:flex;
  justify-content:center;
  align-items:center;
  gap: 12px;
  flex-wrap:wrap;
}
.top-logos img{
  width:160px;
  height:160px;
  object-fit:contain;
  border-radius:50%;
  background:transparent;
  padding:0;

  transition:transform .45s cubic-bezier(.2,.9,.3,1), box-shadow .45s;
  transform-origin:center center;
  animation:floaty 6s ease-in-out infinite;
}

@keyframes floaty{
  0%{ transform:translateY(0) rotate(-1deg); }
  50%{ transform:translateY(-8px) rotate(1.2deg); }
  100%{ transform:translateY(0) rotate(-1deg); }
}

/* Head */
h1{text-align:center;color:var(--blue);margin:6px 0;}
p.lead{text-align:center;color:var(--muted);margin:0 0 6px;}

/* Cards */
.card{
  background:var(--card);
  padding:16px;
  border-radius:12px;
  box-shadow:0 6px 18px rgba(2,18,42,0.04);
}

/* Form */
form.grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
}
label{font-weight:600;margin-bottom:6px;display:block;color:#0f1724;}
input,select{
  width:95%;
  padding:10px;
  border-radius:8px;
  border:1px solid #cfdff0;
  background:#ffffff;
  font-size:14px;
  box-sizing:border-box;
}
.full{grid-column:1/-1;display:flex;gap:12px;align-items:center;}
button.primary{
  background:var(--blue);
  color:white;
  padding:12px;
  border-radius:8px;
  border:none;
  font-weight:700;
  cursor:pointer;
  width:100%;
}
.small{
  background:transparent;
  color:var(--blue);
  padding:10px;
  border-radius:8px;
  border:1px dashed var(--muted);
  cursor:pointer;
}

/* Results / metrics */
.results{
  display:flex;
  gap:18px;
  flex-wrap:wrap;
  justify-content:center;
}
.metric{
  flex:1 1 180px;
  padding:16px;
  border-radius:12px;
  background:var(--card);
  text-align:center;
  box-shadow:0 4px 12px rgba(2,18,42,0.04);
}
.metric h3{margin:12px 0 6px;color:var(--blue);}
.metric p{margin:6px 0 0;color:#375b7a;}
.description{margin-top:6px;font-size:13px;color:#7b98b0;}

canvas{display:block;margin:0 auto;}

/* Notifications area (placed under results) */
.notifications {
  margin-top:18px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
  pointer-events:none;
  width:100%;
}
.notification-card{
  width:100%;
  max-width:640px;
  background:linear-gradient(180deg,#ffffff,#f8fbff);
  border-radius:10px;
  padding:12px 14px;
  box-shadow:0 10px 30px rgba(2,18,42,0.12);
  opacity:0;
  transform:translateY(8px) scale(.98);
  transition:opacity .35s cubic-bezier(.2,.9,.3,1), transform .45s cubic-bezier(.2,.9,.3,1);
  pointer-events:auto;
}
.notification-card.show{opacity:1; transform:translateY(0);}
.notification-card .title{font-weight:700;color:var(--blue);margin-bottom:6px;}
.notification-card .body{font-size:14px;color:#0f1724;}

/* priority / alert styling */
.notification-card.priority{ border-left:6px solid rgba(255,77,79,0.92); box-shadow:0 18px 44px rgba(255,77,79,0.06); }
.notification-card.priority .title{color:#b92b2b;}

/* subtle pop when showing */
.notification-card.show{ animation:pop-in .42s cubic-bezier(.2,.9,.3,1); }
@keyframes pop-in{
  0%{ opacity:0; transform:translateY(10px) scale(.98); }
  70%{ opacity:1; transform:translateY(-4px) scale(1.02); }
  100%{ opacity:1; transform:translateY(0) scale(1); }
}

/* Animated results card when notifications are present */
#resultsCard{ transition:padding .45s cubic-bezier(.2,.9,.3,1), border-radius .45s cubic-bezier(.2,.9,.3,1), box-shadow .45s; overflow:visible; }
#resultsCard.notifications-visible{ padding-bottom:44px; border-radius:16px; box-shadow:0 14px 36px rgba(2,18,42,0.08); }
#resultsCard .results .metric{ transition:transform .45s cubic-bezier(.2,.9,.3,1), opacity .35s ease; }
#resultsCard.notifications-visible .results .metric{ transform:translateY(-8px) scale(1.01); }

/* disabled input visual when palier selected */
.input-muted{ opacity:0.45; }

/* Footer */
.site-footer {
  background: linear-gradient(180deg, rgba(11,99,167,0.06), rgba(255,122,45,0.02));
  color: #0e2130;
  padding: 22px 16px;
  font-size: 14px;
  text-align: center;
  line-height: 1.6;
  border-radius:10px;
  margin-bottom:30px;
}
.site-footer a { color: var(--blue); text-decoration:none; font-weight:600; }
.site-footer p{margin:6px 0;}

/* Responsive */
@media(max-width:720px){
  form.grid{grid-template-columns:1fr;}
  .top-logos img{width:120px;height:120px;}
}
</style>
</head>

<body>
<div class="container">

  <!-- Logo -->
  <div class="top-logos">
    <!-- keep image file named analyx.png next to this HTML -->
    <img src="analyx.png" alt="Club Logo">
  </div>

  <header>
    <h1>Fitness & Performance Analyzer</h1>
    <p class="lead">Entrez vos donn√©es pour obtenir vos indicateurs principaux.</p>
  </header>

  <!-- Inputs -->
  <section class="card">
    <h2>Donn√©es √† saisir</h2>
    <form id="healthForm" class="grid" onsubmit="event.preventDefault(); computeResults(true);">
      <div>
        <label>Sexe</label>
        <select id="sex">
          <option value="male">Homme</option>
          <option value="female">Femme</option>
        </select>
      </div>
      <div>
        <label>Palier (test palier)</label>
        <select id="palier">
          <option value="">Aucun</option>
          <option value="1">Palier 1</option>
          <option value="2">Palier 2</option>
          <option value="3">Palier 3</option>
          <option value="4">Palier 4</option>
          <option value="5">Palier 5</option>
          <option value="6">Palier 6</option>
          <option value="7">Palier 7</option>
          <option value="8">Palier 8</option>
          <option value="9">Palier 9</option>
          <option value="10">Palier 10</option>
          <option value="11">Palier 11</option>
          <option value="12">Palier 12</option>
          <option value="13">Palier 13</option>
          <option value="14">Palier 14</option>
          <option value="15">Palier 15</option>
          <option value="16">Palier 16</option>
          <option value="17">Palier 17</option>
          <option value="18">Palier 18</option>
          <option value="19">Palier 19</option>
          <option value="20">Palier 20</option>
        </select>
      </div>
      <div>
        <label>√Çge</label>
        <input id="age" type="number" min="10" max="120" placeholder="25">
      </div>
      <div>
        <label>Fr√©quence cardiaque repos (bpm)</label>
        <input id="fcRepos" type="number" min="30" max="200" placeholder="70">
      </div>
      <div>
        <label>Saturation en oxyg√®ne SpO‚ÇÇ (%)</label>
        <input id="spo2" type="number" min="50" max="100" placeholder="98">
      </div>
      <div>
        <label>Poids (kg)</label>
        <input id="weight" type="number" min="20" max="400" placeholder="70">
      </div>
      <div>
        <label>Taille (m)</label>
        <input id="height" type="number" step="0.01" min="0.5" max="2.5" placeholder="1.75">
      </div>
      <div>
        <label>Tour de taille (cm)</label>
        <input id="waist" type="number" min="40" max="200" placeholder="80">
      </div>

      <!-- VMA inputs -->
      <div>
        <label>Distance test semi-Cooper 6 min (m) ‚Äî optionnel</label>
        <input id="d6" type="number" placeholder="1200">
      </div>
      <div>
        <label>Distance test Cooper 12 min (m) ‚Äî optionnel</label>
        <input id="d12" type="number" placeholder="2400">
      </div>

      <!-- Ruffier inputs -->
      <div>
        <label>P1 = FC repos</label>
        <input id="p1" type="number" placeholder="70">
      </div>
      <div>
        <label>P2 = FC apr√®s effort</label>
        <input id="p2" type="number" placeholder="120">
      </div>
      <div>
        <label>P3 = FC apr√®s r√©cup√©ration</label>
        <input id="p3" type="number" placeholder="85">
      </div>

      <div class="full">
        <button type="submit" class="primary">Calculer R√©sultats</button>
        <button type="button" class="small" onclick="fillSample(); computeResults(true);">Utiliser donn√©es exemple</button>
        <button type="button" class="small" onclick="clearResults();">R√©initialiser</button>
      </div>
      <div class="full" style="color:var(--muted);font-size:13px;">
        Si des champs sont vides, des valeurs s√ªres par d√©faut seront utilis√©es pour la d√©monstration.
      </div>
    </form>
  </section>

  <!-- Results -->
  <section id="resultsCard" class="card">
    <h2>R√©sultats</h2>
    <div class="results">

      <div class="metric">
        <canvas id="bmiGauge" width="180" height="100"></canvas>
        <h3 id="bmiText">‚Äî</h3>
        <p>IMC</p>
        <div class="description" id="bmiDesc">‚Äî</div>
      </div>

      <div class="metric">
        <canvas id="waistGauge" width="180" height="100"></canvas>
        <h3 id="waistText">‚Äî</h3>
        <p>Ob√©sit√© Andro√Øde</p>
        <div class="description" id="waistDesc">‚Äî</div>
      </div>

      <div class="metric">
        <canvas id="fcGauge" width="180" height="100"></canvas>
        <h3 id="fcText">‚Äî</h3>
        <p>FC max</p>
        <div class="description" id="fcDesc">‚Äî</div>
      </div>

      <div class="metric">
        <canvas id="vmaGauge" width="180" height="100"></canvas>
        <h3 id="vmaText">‚Äî</h3>
        <p>VMA</p>
        <div class="description" id="vmaDesc">‚Äî</div>
      </div>

      <div class="metric">
        <canvas id="vo2Gauge" width="180" height="100"></canvas>
        <h3 id="vo2Text">‚Äî</h3>
        <p>VO‚ÇÇ max</p>
        <div class="description" id="vo2Desc">‚Äî</div>
      </div>

      <div class="metric">
        <canvas id="irGauge" width="180" height="100"></canvas>
        <h3 id="irText">‚Äî</h3>
        <p>Indice Ruffier-Dickson</p>
        <div class="description" id="irDesc">‚Äî</div>
      </div>

    </div>

    <!-- Notifications displayed here (under results) -->
    <div class="notifications" id="notifications"></div>
  </section>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-content">
      <p>&copy; 2025 Este Essaouira Sports Club. Tous droits r√©serv√©s.</p>
      <p>
        Contact : 
        <a href="mailto:info@esteclub.com">info@esteclub.com</a> | 
        <a href="https://instagram.com/club_sportifeste" target="_blank">Instagram</a> | 
        <a href="https://wa.me/212781467073">WhatsApp</a>
      </p>
      <p>Suivez-nous pour rester inform√© de nos activit√©s et √©v√©nements sportifs !</p>
    </div>
  </footer>

</div>

<script>
/* ----------------------------
   Config
   ---------------------------- */
// Notification rotation interval (milliseconds).
// You asked for 13‚Äì20s. Change here to 13000 or 20000 if you want.
// Default set to 20000 (20 seconds) to give more cooldown between messages.
const ROTATION_DELAY = 20000;

/* ----------------------------
   Gauge drawing helpers
   ---------------------------- */
function drawGauge(canvas, value, maxValue, colors, progress = 1){
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  // background arc
  ctx.lineWidth = 12;
  ctx.strokeStyle = '#eee';
  ctx.beginPath();
  ctx.arc(w/2, h, w/2-12, Math.PI, 0, false);
  ctx.stroke();

  // gradient for foreground
  const grad = ctx.createLinearGradient(0,0,w,0);
  colors.forEach((c,i) => grad.addColorStop(i/(colors.length-1), c));
  ctx.strokeStyle = grad;

  const ratio = Math.max(0, Math.min(1, (maxValue === 0 ? 0 : value / maxValue)));
  const endAngle = Math.PI + ratio * Math.PI * progress;
  ctx.beginPath();
  ctx.arc(w/2, h, w/2-12, Math.PI, endAngle, false);
  ctx.stroke();
}

function animateGauge(canvas, value, maxValue, colors, duration = 900){
  let start = null;
  function step(ts){
    if(!start) start = ts;
    const elapsed = ts - start;
    const prog = Math.min(1, elapsed / duration);
    drawGauge(canvas, value, maxValue, colors, prog);
    if(prog < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* ----------------------------
   Notifications system
   ---------------------------- */
const generalMessages = [
  "Faites au moins 30 minutes d‚Äôactivit√© physique par jour.",
  "Hydratez-vous r√©guli√®rement ‚Äî l'eau est votre meilleure alli√©e.",
  "Adoptez une alimentation saine, √©quilibr√©e et vari√©e.",
  "Dormez 7 √† 8 heures par nuit pour bien r√©cup√©rer.",
  "Faites des pauses actives si vous travaillez assis longtemps.",
  "Commencez par des objectifs progressifs : 3 s√©ances courtes par semaine."
];

let rotationInterval = null;
let rotationIndex = 0;

function showNotification(title, body, priority = false, timeout = 8000){
  const container = document.getElementById('notifications');
  const card = document.createElement('div');
  card.className = 'notification-card' + (priority ? ' priority' : '');
  card.innerHTML = '<div class="title">' + title + '</div><div class="body">' + body + '</div>';

  // place priority at top, others appended
  if(priority && container.firstChild){
    container.insertBefore(card, container.firstChild);
  } else {
    container.appendChild(card);
  }

  // small delay to allow CSS animation/transition
  setTimeout(() => card.classList.add('show'), 30);

  // automatic removal with a graceful hide
  const removeAfter = Math.max(4000, timeout);
  setTimeout(() => {
    card.classList.remove('show');
    setTimeout(() => { if(card.parentNode) card.parentNode.removeChild(card); }, 420);
  }, removeAfter);
}

function startRotation(customMessages){
  // If provided, customMessages is an array of {title,body}
  if(rotationInterval) clearInterval(rotationInterval);
  const messages = (customMessages && customMessages.length) ? customMessages :
    generalMessages.map(m => ({title:'Conseil sant√©', body:m}));

  // initial tick right away
  function tick(){
    const msg = messages[rotationIndex % messages.length];
    showNotification(msg.title, msg.body, false, Math.max(6000, ROTATION_DELAY - 2000));
    rotationIndex++;
  }
  tick();
  rotationInterval = setInterval(tick, ROTATION_DELAY);
}

function stopRotation(){
  if(rotationInterval) {
    clearInterval(rotationInterval);
    rotationInterval = null;
  }
}

// Fade out existing notifications smoothly, then remove them from DOM.
function clearNotificationsWithFade(fadeMs = 420){
  const container = document.getElementById('notifications');
  if(!container) return;
  // Remove 'show' so CSS transition plays
  const cards = Array.from(container.children);
  cards.forEach(card => {
    card.classList.remove('show');
  });
  // Remove from DOM after the transition completes
  setTimeout(() => {
    if(container) container.innerHTML = '';
  }, fadeMs + 40);
}

/* ----------------------------
   Personalized alerts builder
   ---------------------------- */
function makeAlerts(results){
  const alerts = [];

  // IMC
  if(results.bmi >= 30){
    alerts.push({title:'Alerte ‚Äî IMC', body:'Votre IMC indique une ob√©sit√©. Envisagez un suivi nutritionnel et une activit√© r√©guli√®re.'});
  } else if(results.bmi >= 25){
    alerts.push({title:'Conseil ‚Äî IMC', body:'Surpoids d√©tect√© : r√©duisez aliments riches en calories vides et augmentez activit√©.'});
  }

  // Tour de taille
  if(results.waistRisk){
    alerts.push({title:'Alerte ‚Äî Tour de taille', body:'Tour de taille √©lev√© ‚Äî risque cardio. Ciblez perte abdominale via cardio et alimentation.'});
  }

  // SpO2
  if(results.spo2 < 95){
    alerts.push({title:'Alerte ‚Äî SpO‚ÇÇ', body:'Saturation en oxyg√®ne basse. Si persistante, consultez un professionnel de sant√©.'});
  }

  // VMA
  if(results.vma && results.vma < 10){
    alerts.push({title:'Endurance faible', body:'VMA basse. Initiez entra√Ænements d‚Äôendurance progressifs (30‚Äì45 min, 3√ó/sem).'});
  }

  // Ruffier
  if(results.ir > 15){
    alerts.push({title:'Alerte ‚Äî Ruffier', body:'Indice Ruffier tr√®s faible: √©vitez efforts intenses sans suivi m√©dical.'});
  } else if(results.ir > 10){
    alerts.push({title:'Ruffier ‚Äî Moyen', body:'R√©cup√©ration √† am√©liorer : travail progressif et repos.'});
  }

  if(alerts.length === 0){
    alerts.push({title:'Bravo üëç', body:'Vos indicateurs principaux sont dans la norme. Continuez ainsi !'});
  }

  return alerts;
}

/* ----------------------------
   Palier table (from provided image)
   ---------------------------- */
const palierTable = {
  1:{duree:1, vitesse:8.5, vma:8.8, vo2:23.6, vo2kg:46.9},
  2:{duree:2, vitesse:9.0, vma:9.5, vo2:26.6, vo2kg:49.0},
  3:{duree:3, vitesse:9.5, vma:10.3, vo2:29.6, vo2kg:51.1},
  4:{duree:4, vitesse:10.0, vma:11.0, vo2:32.6, vo2kg:53.1},
  5:{duree:5, vitesse:10.5, vma:11.8, vo2:35.6, vo2kg:55.2},
  6:{duree:6, vitesse:11.0, vma:12.5, vo2:38.6, vo2kg:57.3},
  7:{duree:7, vitesse:11.5, vma:13.3, vo2:41.6, vo2kg:59.2},
  8:{duree:8, vitesse:12.0, vma:14.0, vo2:44.6, vo2kg:61.5},
  9:{duree:9, vitesse:12.5, vma:14.8, vo2:47.6, vo2kg:63.5},
 10:{duree:10, vitesse:13.0, vma:15.5, vo2:50.6, vo2kg:65.6},
 11:{duree:11, vitesse:13.5, vma:16.3, vo2:53.6, vo2kg:67.7},
 12:{duree:12, vitesse:14.0, vma:17.0, vo2:56.6, vo2kg:69.8},
 13:{duree:13, vitesse:14.5, vma:17.8, vo2:59.6, vo2kg:71.9},
 14:{duree:14, vitesse:15.0, vma:18.5, vo2:62.6, vo2kg:73.9},
 15:{duree:15, vitesse:15.5, vma:19.3, vo2:65.6, vo2kg:76.0},
 16:{duree:16, vitesse:16.0, vma:20.0, vo2:68.6, vo2kg:78.1},
 17:{duree:17, vitesse:16.5, vma:20.8, vo2:71.6, vo2kg:80.2},
 18:{duree:18, vitesse:17.0, vma:21.5, vo2:74.6, vo2kg:82.3},
 19:{duree:19, vitesse:17.5, vma:22.3, vo2:77.6, vo2kg:84.3},
 20:{duree:20, vitesse:18.0, vma:23.0, vo2:80.6, vo2kg:86.4}
};

// When a palier is selected we disable other inputs and use palier values only
function applyPalierSelection(){
  const sel = document.getElementById('palier');
  if(!sel) return;
  const val = sel.value;
  const idsToDisable = ['age','fcRepos','spo2','weight','height','waist','d6','d12','p1','p2','p3'];

  if(val === ''){
    // enable all
    idsToDisable.forEach(id => {
      const el = document.getElementById(id);
      if(el){ el.disabled = false; el.classList.remove('input-muted'); }
    });
    // remove palier extra display
    const extra = document.getElementById('palierExtra'); if(extra) extra.remove();
    // restore original Ruffier label if we changed it
    const irP = document.getElementById('irText') && document.getElementById('irText').nextElementSibling;
    if(irP && window._originalIrLabel){ irP.innerText = window._originalIrLabel; }
    // recompute using current input values
    computeResults(false);
    return;
  }

  // disable other inputs (visual + actual disabled)
  idsToDisable.forEach(id => {
    const el = document.getElementById(id);
    if(el){ el.disabled = true; el.classList.add('input-muted'); }
  });

  // Get palier data and show relevant outputs
  const p = palierTable[Number(val)];
  if(!p) return;

  // Clear out unrelated result fields
  document.getElementById('bmiText').innerText = '‚Äî';
  document.getElementById('bmiDesc').innerText = '‚Äî';
  document.getElementById('waistText').innerText = '‚Äî';
  document.getElementById('waistDesc').innerText = '‚Äî';
  document.getElementById('fcText').innerText = '‚Äî';
  document.getElementById('fcDesc').innerText = '‚Äî';
  document.getElementById('irText').innerText = '‚Äî';
  document.getElementById('irDesc').innerText = '‚Äî';

  // repurpose the Ruffier metric label to show VO2max (mL/min/kg)
  const irP = document.getElementById('irText') && document.getElementById('irText').nextElementSibling;
  if(irP){
    if(!window._originalIrLabel) window._originalIrLabel = irP.innerText;
    irP.innerText = 'VO‚ÇÇmaxsp (mL/kg/min)';
  }

  // show VO2 per kg in the Ruffier slot
  document.getElementById('irText').innerText = p.vo2kg;
  document.getElementById('irDesc').innerText = 'VO‚ÇÇmax par kg ‚Äî valeur sur palier'

  // repurpose the imc label to show duree 
  const bmP = document.getElementById('bmiGauge') && document.getElementById('bmiGauge').nextElementSibling;
  if(bmP){
    if(!window._originalbmLabel) window._originalbmLabel = irP.innerText;
    bmP.innerText = 'Palier ' + val + ' ‚Äî Dur√©e ' + p.duree + ' min ‚Äî Vitesse ' + p.vitesse + ' km/h';
  }

// show duree  in the imc slot
  document.getElementById('bmiGauge').innerText = p.duree + ' min';
  document.getElementById('bmiText').innerText ='Dur√©e  ‚Äî' + p.duree + ' min';

  
  // Use palier values for VMA / VO2 / vitesse and show duree
  document.getElementById('vmaText').innerText =  'VMA  ‚Äî' + p.vma + ' km/h';
  document.getElementById('vmaDesc').innerText = 'Valeur palier (table)';

  document.getElementById('vo2Text').innerText = 'V02 max ‚Äî' + p.vo2 + ' ml/kg/min';
  document.getElementById('vo2Desc').innerText = 'Valeur palier (table)';

    document.getElementById('waistText').innerText = 'vitesse  ‚Äî' + p.vitesse + ' km/h';
  document.getElementById('waistDesc').innerText = 'Valeur palier (table)';

  // add a small extra display for vitesse and duree under results (if not present)
  let extra = document.getElementById('palierExtra');
  if(!extra){
    extra = document.createElement('div');
    extra.id = 'palierExtra';
    extra.style.textAlign = 'center';
    extra.style.marginTop = '8px';
    extra.style.color = '#375b7a';
    document.getElementById('resultsCard').appendChild(extra);
  }

  // Animate gauges to palier-provided values
  animateGauge(document.getElementById('vmaGauge'), p.vma, 25, ['#0b63a7','#fcd34d','#ff7a2d']);
  animateGauge(document.getElementById('vo2Gauge'), p.vo2, 100, ['#ff7a2d','#fcd34d','#0b63a7']);
  // clear other gauges visually
  animateGauge(document.getElementById('bmiGauge'), 0, 40, ['#ff7a2d','#fcd34d','#0b63a7']);
  animateGauge(document.getElementById('waistGauge'), 0, 140, ['#0b63a7','#fcd34d','#ff7a2d']);
  animateGauge(document.getElementById('fcGauge'), 0, 220, ['#0b63a7','#fcd34d','#ff7a2d']);
  animateGauge(document.getElementById('irGauge'), 0, 25, ['#ff7a2d','#fcd34d','#0b63a7']);
}
// attach handler for palier select
document.addEventListener('change', function(e){
  if(e.target && e.target.id === 'palier'){
    applyPalierSelection();
  }
});

/* ----------------------------
   Main compute function (all formulas from PDF)
   ---------------------------- */
function computeResults(showNotificationsAfterCompute = true){
  // fade out any existing notifications before showing new ones
  clearNotificationsWithFade();
  // stop the automatic rotation so we don't immediately get new tips
  stopRotation();
  // If a palier is selected, use palier values only and do not run normal input-based calculations
  const palSel = document.getElementById('palier');
  if(palSel && palSel.value){
    applyPalierSelection();
    // after showing palier results, restart rotation after a short delay
    setTimeout(() => startRotation(), 600);
    return;
  }
  // Gather inputs with safe defaults if empty
  const sex = (document.getElementById('sex').value) || 'male';
  const age = Number(document.getElementById('age').value) || 25;
  const fcRepos = Number(document.getElementById('fcRepos').value) || 70;
  const spo2 = Number(document.getElementById('spo2').value) || 98;
  const weight = Number(document.getElementById('weight').value) || 70;
  const height = Number(document.getElementById('height').value) || 1.75;
  const waist = Number(document.getElementById('waist').value) || 80;
  const d6 = Number(document.getElementById('d6').value) || 0;
  const d12 = Number(document.getElementById('d12').value) || 0;
  const p1 = Number(document.getElementById('p1').value) || fcRepos;
  const p2 = Number(document.getElementById('p2').value) || (fcRepos + 50);
  const p3 = Number(document.getElementById('p3').value) || Math.round((fcRepos + p2) / 2);

  // 1) IMC
  const bmi = +(weight / (height * height));
  const bmiLabel = bmi < 18.5 ? "Insuffisance pond√©rale" : bmi < 25 ? "Corpulence normale" : bmi < 30 ? "Surpoids" : "Ob√©sit√©";

  // 2) Ob√©sit√© andro√Øde
  const waistRisk = (sex === 'male' && waist > 102) || (sex === 'female' && waist > 88);

  // 3) FC max
  const fcMax = sex === 'male' ? 220 - age : 226 - age;

  // 4) VMA
  let vma = 0;
  let vmaMethod = 'Aucun test fourni';
  if(d12 > 0){ vma = +(d12 / 200); vmaMethod = 'Cooper 12 min'; }
  else if(d6 > 0){ vma = +(d6 / 100); vmaMethod = 'Semi-Cooper 6 min'; }
  vma = +vma.toFixed(1);
  const vmaLabel = vma === 0 ? 'Aucun test' : vma < 10 ? 'Faible' : vma <= 13 ? 'Moyenne' : vma <= 17 ? 'Bonne' : 'Excellente';

  // 5) VO2max
  const vo2 = vma > 0 ? +(3.46 * vma + 12.2).toFixed(1) : 0;
  const vo2Label = vo2 === 0 ? 'Aucun test' : vo2 < 35 ? 'Faible' : vo2 <= 45 ? 'Moyenne' : vo2 <= 55 ? 'Bonne' : 'Excellente';

  // 6) Ruffier-Dickson IR
  const ir = +(((p1 + p2 + p3) - 200) / 10).toFixed(1);
  const irLabel = ir <= 5 ? 'Tr√®s bonne adaptation cardiovasculaire' : ir <= 10 ? 'Moyenne' : ir <= 15 ? 'Faible' : 'Tr√®s faible';

  // Update DOM values
  document.getElementById('bmiText').innerText = isFinite(bmi) ? bmi.toFixed(1) : '‚Äî';
  document.getElementById('bmiDesc').innerText = isFinite(bmi) ? bmiLabel : '‚Äî';

  document.getElementById('waistText').innerText = waist ? (waist + ' cm ‚Äî ' + (waistRisk ? 'Risque' : 'Pas de risque')) : '‚Äî';
  document.getElementById('waistDesc').innerText = waist ? (waistRisk ? 'Ob√©sit√© andro√Øde' : 'Tour de taille normal') : '‚Äî';

  document.getElementById('fcText').innerText = isFinite(fcMax) ? (fcMax + ' bpm') : '‚Äî';
  document.getElementById('fcDesc').innerText = 'FC max recommand√©e';

  document.getElementById('vmaText').innerText = vma ? (vma + ' km/h') : '‚Äî';
  document.getElementById('vmaDesc').innerText = vma ? (vmaMethod + ' ‚Äî ' + vmaLabel) : '‚Äî';

  document.getElementById('vo2Text').innerText = vo2 ? (vo2 + ' ml/kg/min') : '‚Äî';
  document.getElementById('vo2Desc').innerText = vo2 ? vo2Label : '‚Äî';

  document.getElementById('irText').innerText = isFinite(ir) ? ir : '‚Äî';
  document.getElementById('irDesc').innerText = isFinite(ir) ? irLabel : '‚Äî';

  // Animate gauges (safe max values)
  animateGauge(document.getElementById('bmiGauge'), isFinite(bmi) ? bmi : 0, 40, ['#ff7a2d','#fcd34d','#0b63a7']);
  animateGauge(document.getElementById('waistGauge'), waist || 0, 140, ['#0b63a7','#fcd34d','#ff7a2d']);
  animateGauge(document.getElementById('fcGauge'), fcMax || 0, 220, ['#0b63a7','#fcd34d','#ff7a2d']);
  animateGauge(document.getElementById('vmaGauge'), vma || 0, 25, ['#0b63a7','#fcd34d','#ff7a2d']);
  animateGauge(document.getElementById('vo2Gauge'), vo2 || 0, 80, ['#ff7a2d','#fcd34d','#0b63a7']);
  animateGauge(document.getElementById('irGauge'), Math.max(0, isFinite(ir) ? ir : 0), 25, ['#ff7a2d','#fcd34d','#0b63a7']);

  // Build results object for alerts/rotation
  const results = {
    bmi: isFinite(bmi) ? bmi : 0,
    waistRisk,
    spo2: spo2 || 0,
    vma: vma || 0,
    vo2: vo2 || 0,
    ir: isFinite(ir) ? ir : 0
  };

  // Priority alerts
  const alerts = makeAlerts(results);
  // Show immediate priority alerts (max 3) after existing notifications have faded
  const fadeDelay = 480; // slightly longer than CSS transition to ensure fade completes
  if(showNotificationsAfterCompute){
    setTimeout(() => {
      alerts.slice(0,3).forEach(a => showNotification(a.title, a.body, true, 9000));
    }, fadeDelay);
  }

  // Prepare rotation: place alerts first then general messages
  // Exclude the specific '30 minutes' tip from appearing immediately after a calculation
  const rotationMessages = alerts.concat(
    generalMessages
      .map(m => ({title:'Conseil sant√©', body:m}))
      .filter(m => !m.body.includes('30 minutes'))
  );
  // Start rotation after the fade so it doesn't immediately show new tips over the old ones
  setTimeout(() => startRotation(rotationMessages), fadeDelay + 40);
}

/* ----------------------------
   Sample + reset helpers
   ---------------------------- */
function fillSample(){
  document.getElementById('sex').value='male';
  document.getElementById('age').value='22';
  document.getElementById('fcRepos').value='62';
  document.getElementById('spo2').value='98';
  document.getElementById('weight').value='72';
  document.getElementById('height').value='1.78';
  document.getElementById('waist').value='82';
  document.getElementById('d6').value='1400';
  document.getElementById('d12').value='';
  document.getElementById('p1').value='62';
  document.getElementById('p2').value='135';
  document.getElementById('p3').value='88';
}

function clearResults(){
  // Clear text fields (not inputs) and stop rotation & notifications
  document.getElementById('bmiText').innerText='‚Äî';
  document.getElementById('bmiDesc').innerText='‚Äî';
  document.getElementById('waistText').innerText='‚Äî';
  document.getElementById('waistDesc').innerText='‚Äî';
  document.getElementById('fcText').innerText='‚Äî';
  document.getElementById('fcDesc').innerText='‚Äî';
  document.getElementById('vmaText').innerText='‚Äî';
  document.getElementById('vmaDesc').innerText='‚Äî';
  document.getElementById('vo2Text').innerText='‚Äî';
  document.getElementById('vo2Desc').innerText='‚Äî';
  document.getElementById('irText').innerText='‚Äî';
  document.getElementById('irDesc').innerText='‚Äî';

  stopRotation();
  const container = document.getElementById('notifications');
  container.innerHTML = '';
}
/* ----------------------------
  Initial start
  ---------------------------- */
startRotation(); // start rotating generic messages

// Watch notifications container and toggle a class on the results card so
// the outer frame animates smoothly when notifications appear/disappear.
(function(){
  const resultsCard = document.getElementById('resultsCard');
  const notifications = document.getElementById('notifications');
  if(!resultsCard || !notifications) return;

  function updateState(){
    if(notifications.children.length > 0){
      resultsCard.classList.add('notifications-visible');
    } else {
      resultsCard.classList.remove('notifications-visible');
    }
  }

  // Observe additions/removals so the class toggles automatically
  const mo = new MutationObserver(updateState);
  mo.observe(notifications, { childList: true });

  // initial state
  updateState();
})();

</script>
</body>
</html>